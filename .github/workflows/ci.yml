
# =============================================================================
# Triggers: Push to main and sophia/ci branches, Pull requests to main
# Actions:
#   1. Builds unit tests and runs on native_sim
#   2. Builds misogate for nrf7002dk
#   3. Builds misonode for nrf7002dk
#   4. Uploads test logs and .hex artifacts
# =============================================================================

name: CI Build & Test

on:
  push:
    branches: [main, master, sophia/ci]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allow manual trigger

env:
  ZEPHYR_IMAGE: ghcr.io/zephyrproject-rtos/zephyr-build:main

jobs:
  unit-tests:
    name: Unit Tests (native_sim)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/zephyrproject-rtos/zephyr-build:main
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize West workspace
        run: |
          west init -l .
          west update --narrow --fetch-opt=--depth=1

      - name: Build unit tests
        run: |
          west build -p always \
            -b native_sim/native/64 \
            tests/unit_test \
            --pristine \
            -- -DCONFIG_ZTEST=y

      - name: Run unit tests
        id: run_tests
        run: |
          # Run tests and capture output
          west build -t run tests/unit_test 2>&1 | tee test_output.log
          
          # Check for test failures in output
          if grep -q "FAIL" test_output.log; then
            echo "::error::Unit tests failed"
            exit 1
          fi
          
          echo "✓ All unit tests passed"

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-logs
          path: |
            test_output.log
            build/zephyr/zephyr.log
          retention-days: 30

  build-misogate:
    name: Build misogate (nRF7002DK)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/zephyrproject-rtos/zephyr-build:main
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize West workspace
        run: |
          west init -l .
          west update --narrow --fetch-opt=--depth=1

      - name: Build misogate
        run: |
          west build -p always \
            -b nrf7002dk/nrf5340/cpuapp \
            misogate \
            --pristine

      - name: Upload misogate artifacts
        uses: actions/upload-artifact@v4
        with:
          name: misogate-firmware
          path: |
            build/zephyr/zephyr.hex
            build/zephyr/zephyr.bin
            build/zephyr/zephyr.elf
            build/zephyr/.config
            build/zephyr/zephyr.log
          retention-days: 30

  build-misonode:
    name: Build misonode (nRF7002DK)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/zephyrproject-rtos/zephyr-build:main
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize West workspace
        run: |
          west init -l .
          west update --narrow --fetch-opt=--depth=1

      - name: Build misonode
        run: |
          west build -p always \
            -b nrf7002dk/nrf5340/cpuapp \
            misonode \
            --pristine

      - name: Upload misonode artifacts
        uses: actions/upload-artifact@v4
        with:
          name: misonode-firmware
          path: |
            build/zephyr/zephyr.hex
            build/zephyr/zephyr.bin
            build/zephyr/zephyr.elf
            build/zephyr/.config
            build/zephyr/zephyr.log
          retention-days: 30

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install analysis tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck clang-format

      - name: Run clang-format check
        run: |
          echo "Checking code formatting..."
          find misogate misonode tests -name '*.c' -o -name '*.h' | head -50 | while read file; do
            if [ -f "$file" ]; then
              clang-format --style=file --dry-run --Werror "$file" 2>&1 || {
                echo "::warning file=$file::File needs formatting"
              }
            fi
          done
          echo "✓ Format check complete"

      - name: Run cppcheck
        run: |
          echo "Running static analysis..."
          cppcheck --error-exitcode=0 \
                   --enable=warning,performance,portability \
                   --suppress=missingIncludeSystem \
                   --suppress=unusedFunction \
                   --suppress=unmatchedSuppression \
                   --inline-suppr \
                   --quiet \
                   misogate/src misonode/src 2>&1 | tee cppcheck_report.txt
          
          if [ -s cppcheck_report.txt ]; then
            echo "::warning::cppcheck found potential issues"
            cat cppcheck_report.txt
          fi
          echo "✓ Static analysis complete"

      - name: Upload analysis reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: static-analysis-reports
          path: |
            cppcheck_report.txt
          retention-days: 30

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, build-misogate, build-misonode, static-analysis]
    if: always()
    
    steps:
      - name: Check job results
        run: |
          echo "========================================"
          echo "CI Pipeline Summary"
          echo "========================================"
          echo "Unit Tests:      ${{ needs.unit-tests.result }}"
          echo "Build misogate:  ${{ needs.build-misogate.result }}"
          echo "Build misonode:  ${{ needs.build-misonode.result }}"
          echo "Static Analysis: ${{ needs.static-analysis.result }}"
          echo "========================================"
          
          if [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.build-misogate.result }}" != "success" ] || \
             [ "${{ needs.build-misonode.result }}" != "success" ]; then
            echo "::error::One or more CI jobs failed"
            exit 1
          fi
          
          echo "✓ All CI checks passed!"
