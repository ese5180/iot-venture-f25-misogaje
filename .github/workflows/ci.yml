# =============================================================================
# GitHub Actions CI Pipeline for nRF Connect SDK Project
# =============================================================================

name: CI Build & Test

on:
  push:
    branches: [main, master, sophia/ci]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  # ===========================================================================
  # Job 1: Build and run MMC5983MA unit tests
  # ===========================================================================
  unit-tests-mmc5983ma:
    name: Unit Tests - MMC5983MA (native_sim)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf \
            ccache dfu-util device-tree-compiler wget \
            python3-dev python3-pip python3-setuptools python3-tk python3-wheel \
            xz-utils file make gcc gcc-multilib g++-multilib libsdl2-dev

      - name: Install West
        run: pip3 install west

      - name: Setup nRF Connect SDK
        run: |
          west init -m https://github.com/nrfconnect/sdk-nrf --mr v2.9.0 ncs
          cd ncs
          west update --narrow --fetch-opt=--depth=1
          ln -s $GITHUB_WORKSPACE project

      - name: Install Zephyr SDK (native tools)
        run: |
          cd ~
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.8/zephyr-sdk-0.16.8_linux-x86_64_minimal.tar.xz
          tar xf zephyr-sdk-0.16.8_linux-x86_64_minimal.tar.xz
          cd zephyr-sdk-0.16.8
          ./setup.sh -t x86_64-zephyr-elf -h -c

      - name: Install Python dependencies
        run: |
          pip3 install -r ncs/zephyr/scripts/requirements.txt
          pip3 install -r ncs/nrf/scripts/requirements.txt || true

      - name: Build MMC5983MA unit tests
        env:
          ZEPHYR_SDK_INSTALL_DIR: ~/zephyr-sdk-0.16.8
        working-directory: ncs
        run: |
          west build -p always \
            -b native_sim/native/64 \
            project/tests/mmc5983ma_test \
            --pristine

      - name: Run MMC5983MA unit tests
        working-directory: ncs
        run: |
          # For native_sim, run the executable directly
          # Find the zephyr.exe executable
          ZEPHYR_EXE=$(find build -name "zephyr.exe" -type f | head -1)
          
          if [ -z "$ZEPHYR_EXE" ]; then
            echo "::error::Could not find zephyr.exe"
            find build -name "*.exe" -type f || true
            exit 1
          fi
          
          echo "Running: $ZEPHYR_EXE"
          $ZEPHYR_EXE 2>&1 | tee $GITHUB_WORKSPACE/mmc5983ma_test_output.log
          
          # Check for test failures
          if grep -q "FAIL" $GITHUB_WORKSPACE/mmc5983ma_test_output.log; then
            echo "::error::MMC5983MA unit tests failed"
            exit 1
          fi
          
          if grep -q "PASS" $GITHUB_WORKSPACE/mmc5983ma_test_output.log; then
            echo "✓ MMC5983MA unit tests passed"
          fi

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mmc5983ma-test-logs
          path: mmc5983ma_test_output.log
          retention-days: 30

  # ===========================================================================
  # Job 2: Build magsens for nRF7002DK
  # ===========================================================================
  build-magsens:
    name: Build magsens (nRF7002DK)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf \
            ccache dfu-util device-tree-compiler wget \
            python3-dev python3-pip python3-setuptools python3-tk python3-wheel \
            xz-utils file make gcc gcc-multilib g++-multilib libsdl2-dev

      - name: Install West
        run: pip3 install west

      - name: Setup nRF Connect SDK
        run: |
          west init -m https://github.com/nrfconnect/sdk-nrf --mr v2.9.0 ncs
          cd ncs
          west update --narrow --fetch-opt=--depth=1
          ln -s $GITHUB_WORKSPACE project

      - name: Install Zephyr SDK (ARM toolchain)
        run: |
          cd ~
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.8/zephyr-sdk-0.16.8_linux-x86_64_minimal.tar.xz
          tar xf zephyr-sdk-0.16.8_linux-x86_64_minimal.tar.xz
          cd zephyr-sdk-0.16.8
          ./setup.sh -t arm-zephyr-eabi -h -c

      - name: Install Python dependencies
        run: |
          pip3 install -r ncs/zephyr/scripts/requirements.txt
          pip3 install -r ncs/nrf/scripts/requirements.txt || true

      - name: Build magsens
        env:
          ZEPHYR_SDK_INSTALL_DIR: ~/zephyr-sdk-0.16.8
        working-directory: ncs
        run: |
          west build -p always \
            -b nrf7002dk/nrf5340/cpuapp \
            project/magsens \
            --pristine

      - name: Find and copy artifacts
        if: always()
        run: |
          mkdir -p artifacts
          find ncs/build -name "*.hex" -exec cp {} artifacts/ \; 2>/dev/null || true
          find ncs/build -name "*.bin" -exec cp {} artifacts/ \; 2>/dev/null || true
          find ncs/build -name "zephyr.elf" -exec cp {} artifacts/ \; 2>/dev/null || true
          ls -la artifacts/

      - name: Upload magsens artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: magsens-firmware
          path: artifacts/
          if-no-files-found: warn
          retention-days: 30

  # ===========================================================================
  # Job 3: Build misonode for nRF7002DK
  # ===========================================================================
  build-misonode:
    name: Build misonode (nRF7002DK)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf \
            ccache dfu-util device-tree-compiler wget \
            python3-dev python3-pip python3-setuptools python3-tk python3-wheel \
            xz-utils file make gcc gcc-multilib g++-multilib libsdl2-dev

      - name: Install West
        run: pip3 install west

      - name: Setup nRF Connect SDK
        run: |
          west init -m https://github.com/nrfconnect/sdk-nrf --mr v2.9.0 ncs
          cd ncs
          west update --narrow --fetch-opt=--depth=1
          ln -s $GITHUB_WORKSPACE project

      - name: Install Zephyr SDK (ARM toolchain)
        run: |
          cd ~
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.8/zephyr-sdk-0.16.8_linux-x86_64_minimal.tar.xz
          tar xf zephyr-sdk-0.16.8_linux-x86_64_minimal.tar.xz
          cd zephyr-sdk-0.16.8
          ./setup.sh -t arm-zephyr-eabi -h -c

      - name: Install Python dependencies
        run: |
          pip3 install -r ncs/zephyr/scripts/requirements.txt
          pip3 install -r ncs/nrf/scripts/requirements.txt || true

      - name: Build misonode
        env:
          ZEPHYR_SDK_INSTALL_DIR: ~/zephyr-sdk-0.16.8
        working-directory: ncs
        run: |
          west build -p always \
            -b nrf7002dk/nrf5340/cpuapp \
            project/misonode \
            --pristine

      - name: Find and copy artifacts
        if: always()
        run: |
          mkdir -p artifacts
          find ncs/build -name "*.hex" -exec cp {} artifacts/ \; 2>/dev/null || true
          find ncs/build -name "*.bin" -exec cp {} artifacts/ \; 2>/dev/null || true
          find ncs/build -name "zephyr.elf" -exec cp {} artifacts/ \; 2>/dev/null || true
          ls -la artifacts/

      - name: Upload misonode artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: misonode-firmware
          path: artifacts/
          if-no-files-found: warn
          retention-days: 30

  # ===========================================================================
  # Job 4: Static Analysis
  # ===========================================================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install analysis tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck clang-format

      - name: Run clang-format check
        run: |
          echo "Checking code formatting..."
          find misonode magsens tests -name '*.c' -o -name '*.h' 2>/dev/null | head -50 | while read file; do
            if [ -f "$file" ]; then
              clang-format --style=file --dry-run --Werror "$file" 2>/dev/null || \
                echo "::warning file=$file::File needs formatting"
            fi
          done
          echo "✓ Format check complete"

      - name: Run cppcheck
        run: |
          cppcheck --error-exitcode=0 \
                   --enable=warning,performance,portability \
                   --suppress=missingIncludeSystem \
                   --suppress=unusedFunction \
                   --quiet \
                   misonode/src magsens/src 2>&1 | tee cppcheck_report.txt || true
          echo "✓ Static analysis complete"

      - name: Upload analysis reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: static-analysis-reports
          path: cppcheck_report.txt
          retention-days: 30

  # ===========================================================================
  # Summary
  # ===========================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [unit-tests-mmc5983ma, build-magsens, build-misonode, static-analysis]
    if: always()
    
    steps:
      - name: Check job results
        run: |
          echo "========================================"
          echo "CI Pipeline Summary"
          echo "========================================"
          echo "MMC5983MA Tests: ${{ needs.unit-tests-mmc5983ma.result }}"
          echo "Build magsens:   ${{ needs.build-magsens.result }}"
          echo "Build misonode:  ${{ needs.build-misonode.result }}"
          echo "Static Analysis: ${{ needs.static-analysis.result }}"
          echo "========================================"